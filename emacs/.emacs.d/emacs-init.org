#+TITLE: Emacs config file
#+DATE: 8 Aug 2023
#+AUTHOR: Clancy Rowley
#+PROPERTY: header-args:emacs-lisp :tangle init.el
#+STARTUP: content

* General settings
** Header
#+begin_src emacs-lisp
;;; init.el -- Clancy's Emacs init file

;;; Commentary:
;;; This file is generated from emacs-init.org.  Do not edit this file directly!

;;; Code:
#+end_src

** Garbage collection
Set the garbage collector threshold, to avoid collections
#+begin_src emacs-lisp
(setq gc-cons-percentage 0.5
      gc-cons-threshold (* 128 1024 1024))

(add-hook 'after-init-hook #'garbage-collect t)
#+end_src
** Report time spent loading this file
From [[https://github.com/jwiegley/dot-emacs/blob/master/init.org][John Wiegley's init file]]
#+begin_src emacs-lisp
(defconst emacs-start-time (current-time))

(defun report-time-since-load (&optional suffix)
  (message "Loading init...done (%.3fs)%s"
           (float-time (time-subtract (current-time) emacs-start-time))
           suffix))

(add-hook 'after-init-hook
          #'(lambda () (report-time-since-load " [after-init]"))
          t)
#+end_src

** Auto revert buffers
#+begin_src emacs-lisp
(global-auto-revert-mode t)
#+end_src

** Default major mode
#+begin_src emacs-lisp
(setq-default major-mode 'text-mode)
;;;; Turn on auto-fill for various modes
(add-hook 'text-mode-hook 'turn-on-auto-fill)
#+end_src

** Set path
#+begin_src emacs-lisp
(add-to-list 'exec-path "/Library/TeX/texbin")
(add-to-list 'exec-path "/usr/local/bin")
(setenv "PATH" (concat "/Library/TeX/texbin:/usr/local/bin:" (getenv "PATH")))
#+end_src

** Set default fill column and window size
#+begin_src emacs-lisp
(setq-default fill-column 80)
(setq default-frame-alist
       '((top . 20) (left . 20)
         (width . 100) (height . 60)
         (alpha-background . 90)))
#+end_src

** Remember recent files
#+begin_src emacs-lisp
(recentf-mode 1)
#+end_src

** Enable narrowing
#+begin_src emacs-lisp
(put 'narrow-to-region 'disabled nil)
#+end_src
** Set up package manager
*** Package
#+begin_src emacs-lisp
;;;; ELPA packages
(require 'package)
(add-to-list 'package-archives
	     '("melpa" . "https://melpa.org/packages/") t)
#+end_src

*** Use-package
#+begin_src emacs-lisp
(message "Loading packages...")
(eval-when-compile
  (require 'use-package))
(require 'bind-key)

;; Uncomment the following to profile startup time
;; (setq use-package-compute-statistics t)

;; Download packages automatically if not installed
(require 'use-package-ensure)
(setq use-package-always-ensure t)
;; (setq use-package-verbose t)
#+end_src

*** Delight
Simplify mode line, ignoring some minor modes.

Load this before other packages, because delight provides a keyword for =use-package=
#+begin_src emacs-lisp
(require 'delight)
(delight '((eldoc-mode nil "eldoc")))
(delight '((buffer-face-mode nil "face-remap")))
#+end_src

** Emacs
#+begin_src emacs-lisp
(use-package emacs
  :custom
  (completion-ignored-extensions
   '(".aux"
     ".bbl"
     ".bin"
     ".blg"
     ".git/"
     ".o"
     ".pyc"
     ".so"
     ".synctex.gz"
     ".toc"
     "~"))
  (inhibit-startup-screen t)
  (initial-buffer-choice t)
  (initial-scratch-message "")
  (scroll-bar-mode nil)
  (tool-bar-mode nil)

  ;; files.el
  (make-backup-files t)
  (backup-directory-alist '((".*" . "~/.emacs_backups/")))
  (delete-old-versions t)
  (directory-free-space-args "-kh")
  (version-control t)

  :config
  (setq-default indent-tabs-mode nil)
)
#+end_src

** Emacs path
#+begin_src emacs-lisp
(defsubst emacs-path (fname)
  (expand-file-name fname user-emacs-directory))
#+end_src

** Custom file
Store customizations in a separate file, instead of at the end of this file
#+begin_src emacs-lisp
(setq custom-file (expand-file-name "settings.el" user-emacs-directory))
(when (file-exists-p custom-file)
  (load custom-file))
;; (use-package cus-edit
;;   :custom
;;   (custom-file (emacs-path "settings.el"))
;;   (custom-raised-buttons nil)
;;   (custom-safe-themes
;;    '(default)))
#+end_src

* Custom functions and macros
** Include guards
#+begin_src emacs-lisp
(defun replace-in-string (string regexp newtext)
  "Replace regular expression REGEXP with NEWTEXT in the given STRING."
  (let ((skip (length newtext))
        (start 0))
    (while (string-match regexp string start)
      (setq string (replace-match newtext t t string)
            start (+ skip (match-beginning 0)))))
  string)

(defun insert-include-guard ()
  "Insert an #ifdef include guard in a C header file."
  (interactive)
  (goto-char 1)
  (let* ((inc-name (replace-in-string (buffer-name (current-buffer)) "\\." "_" ) )
         (ftag (concat "" (upcase inc-name ) "" )))
    (insert (concat "#ifndef " ftag))
    (newline)
    (insert (concat "#define " ftag))
    (newline)
    (newline)
    (goto-char (point-max))
    (insert "#endif")
    (newline)
    )
  )
#+end_src

** Comments
#+begin_src emacs-lisp
(defun uncomment-line ()
  "Uncomment the current line."
  (interactive)
  (let (a b)
    (beginning-of-line)
    (setq a (point))
    (forward-line)
    (setq b (point))
    (uncomment-region a b)))
#+end_src

** Date
#+begin_src emacs-lisp
(fset 'date
   [?\C-u ?\M-! ?d ?a ?t ?e return ?\C-n])
#+end_src

** Open links to email messages
#+begin_src emacs-lisp
(require 'url-util)

(defun cr-open-message-link (id)
  "Open the mail message corresponding to the given id."
  (let ((plus-decoded (replace-regexp-in-string " " "+" id t t))
        (allowed-chars (append '(?/ ?@ ?+) url-unreserved-chars)))
   (shell-command
    (concat "open message:" (url-hexify-string plus-decoded allowed-chars)))
  )
)
#+end_src

* Keybindings
** Global keybindings
:PROPERTIES:
:ORDERED:  t
:END:
#+begin_src emacs-lisp
(bind-keys :map global-map
           ("<f12>" . bury-buffer)
           ("s-d"   . date)
           ("C-c n" . display-line-numbers-mode)
           ("C-c v" . variable-pitch-mode))

(bind-keys :map prog-mode-map
           ("<f9>"  . comment-line)
           ("<f10>" . uncomment-line)
           ("C-c d" . eldoc))
#+end_src

** Evil keybindings
#+begin_src emacs-lisp
(use-package evil
  :config
  ;; by default, use Emacs bindings
  (setq evil-default-state 'emacs)
  ;; use vi bindings (Normal mode) only for the following major modes
  (dolist (mode
    '(
      bibtex-mode
      c-mode
      c-ts-mode
      c++-mode
      c++-ts-mode
      conf-mode
      emacs-lisp-mode
      makefile-bsdmake-mode
      org-mode
      python-mode
      python-ts-mode
      sh-mode
      text-mode
      web-mode
    ))
    (evil-set-initial-state mode 'normal))
  ;; use Emacs bindings for the following major modes
  (dolist (mode
    '(
      elfeed-search-mode
      elfeed-show-mode
      grep-mode
      help-mode
      Info-mode
      org-agenda-mode
      rg-mode
    ))
    (evil-set-initial-state mode 'emacs))
  (define-key evil-normal-state-map "\M-." nil)
  (define-key evil-normal-state-map (kbd "C-.") nil)
  (evil-mode 1))

(use-package evil-surround
  :config
  (global-evil-surround-mode 1))

(use-package evil-org
  :after org
  :delight
  :hook (org-mode . evil-org-mode))
#+end_src

** Which-key
Show a menu of available key bindings, after a prefix key is entered
#+begin_src emacs-lisp
(use-package which-key
  :delight
  :config
  (which-key-mode))
#+end_src

* Packages
** 750 words
#+begin_src emacs-lisp
(use-package 750words
  :load-path "~/.emacs.d/site-lisp/750words/"
  :ensure nil
  :commands (750words-now) ;; Defer loading until you actually run the command
  :config
  ;; Optional: Customize the goal here if you want
  ;; (setq 750words-goal 1000)
  )
#+end_src

** Appearance
*** Fill column indicator
#+begin_src emacs-lisp
(use-package fill-column-indicator
  :hook ((c-mode-common . fci-mode)
	 (python-mode . fci-mode))
  ;; :config
  ;; (setq fci-rule-color (face-attribute font-lock-comment-face :foreground))
  )
#+end_src

*** Pulsar
The variable =pulsar-pulse-functions= lets you add more functions that should
cause a pulse after they're invoked.
#+begin_src emacs-lisp
(use-package pulsar
  :config
  (add-hook 'next-error-hook #'pulsar-pulse-line)
  (add-hook 'consult-after-jump-hook #'pulsar-recenter-middle)
  (add-hook 'consult-after-jump-hook #'pulsar-reveal-entry)
  (add-hook 'imenu-after-jump-hook #'pulsar-recenter-middle)
  (add-hook 'imenu-after-jump-hook #'pulsar-reveal-entry)
  :init
  (pulsar-global-mode t))
#+end_src

*** Rainbow delimiters
#+begin_src emacs-lisp
(use-package rainbow-delimiters
  :hook ((lisp-mode . rainbow-delimiters-mode)
	 (emacs-lisp-mode . rainbow-delimiters-mode)
	 (LaTeX-mode . rainbow-delimiters-mode)))
#+end_src

*** Whitespace
#+begin_src emacs-lisp
(use-package whitespace
  :hook ((c-mode-common LaTeX-mode org-mode python-mode) . whitespace-mode)
  :delight
  :config
  (setq whitespace-style '(face trailing tabs empty tab-mark)))
#+end_src

*** Mode line
#+begin_src emacs-lisp :tangle no
(use-package telephone-line
:config
(telephone-line-mode t))
#+end_src

To use icons in the mode line, run =M-x nerd-icons-install-fonts=
#+begin_src emacs-lisp
(use-package doom-modeline
  :hook (after-init . doom-modeline-mode)
  :init
  (setq doom-modeline-modal-icon nil
        doom-modeline-env-python-executable "python")
  :custom-face
  (doom-modeline-evil-insert-state ((t (:inherit font-lock-keyword-face))))
  (doom-modeline-evil-normal-state ((t (:inherit doom-modeline-info))))
  (doom-modeline-evil-emacs-state ((t (:inherit font-lock-builtin-face)))))
#+end_src

** Bibliography
*** Set location of bib files
#+begin_src emacs-lisp
(defconst cr/bib-files '("~/gd/texmf/bibtex/bib/master.bib" "~/gd/texmf/bibtex/bib/jfull.bib"))
#+end_src

*** Citar
Disabled for now
#+begin_src emacs-lisp
(use-package citar
  :disabled
  :custom
  (citar-bibliography cr/bib-files)
  (setq citar-default-action 'citar-open-entry)
  :hook
  ;; (LaTeX-mode . citar-capf-setup)
  (org-mode . citar-capf-setup))

(use-package citar-embark
  :disabled
  :after (citar embark)
  ;; :delight t
  :hook org-mode)
#+end_src

*** Org citations
#+begin_src emacs-lisp
(use-package oc
  :disabled t
  :defer t
  :after org
  :config
  (require 'oc-biblatex)
  (setq org-cite-global-bibliography cr/bib-files)
  ;; (require 'citar)
  ;; (setq org-cite-insert-processor 'citar
  ;;       org-cite-follow-processor 'citar
  ;;       org-cite-activate-processor 'citar
  ;;       org-cite-export-processors '((latex biblatex)
  ;;                                    (t basic)))
)
#+end_src

** Bookmark
#+begin_src emacs-lisp
(use-package bookmark
  :hook (bookmark-bmenu-mode . hl-line-mode))
#+end_src

** Completion
*** Consult
#+begin_src emacs-lisp
;; Example configuration for Consult
(use-package consult
  :bind (;; C-c bindings in `mode-specific-map'
         ("C-c M-x" . consult-mode-command)
         ("C-c k" . consult-kmacro)
         ("C-c m" . consult-man)
         ("C-c i" . consult-info)
         ([remap Info-search] . consult-info)
         ;; C-x bindings in `ctl-x-map'
         ("C-x M-:" . consult-complex-command)     ;; orig. repeat-complex-command
         ("C-x b" . consult-buffer)                ;; orig. switch-to-buffer
         ("C-x 4 b" . consult-buffer-other-window) ;; orig. switch-to-buffer-other-window
         ("C-x 5 b" . consult-buffer-other-frame)  ;; orig. switch-to-buffer-other-frame
         ("C-x r b" . consult-bookmark)            ;; orig. bookmark-jump
         ("C-x p b" . consult-project-buffer)      ;; orig. project-switch-to-buffer
         ;; Custom M-# bindings for fast register access
         ("M-#" . consult-register-load)
         ("M-'" . consult-register-store)          ;; orig. abbrev-prefix-mark (unrelated)
         ("C-M-#" . consult-register)
         ;; Other custom bindings
         ("M-y" . consult-yank-pop)                ;; orig. yank-pop
         ;; M-g bindings in `goto-map'
         ("M-g e" . consult-compile-error)
         ("M-g f" . consult-flymake)               ;; Alternative: consult-flycheck
         ("M-g g" . consult-goto-line)             ;; orig. goto-line
         ("M-g M-g" . consult-goto-line)           ;; orig. goto-line
         ("M-g o" . consult-outline)               ;; Alternative: consult-org-heading
         ("M-g m" . consult-mark)
         ("M-g k" . consult-global-mark)
         ("M-g i" . consult-imenu)
         ("M-g I" . consult-imenu-multi)
         ;; M-s bindings in `search-map'
         ("M-s d" . consult-find)
         ("M-s D" . consult-locate)
         ("M-s g" . consult-grep)
         ("M-s G" . consult-git-grep)
         ("M-s r" . consult-ripgrep)
         ("M-s l" . consult-line)
         ("M-s L" . consult-line-multi)
         ("M-s k" . consult-keep-lines)
         ("M-s u" . consult-focus-lines)
         ;; Isearch integration
         ("M-s e" . consult-isearch-history)
         :map isearch-mode-map
         ("M-e" . consult-isearch-history)         ;; orig. isearch-edit-string
         ("M-s e" . consult-isearch-history)       ;; orig. isearch-edit-string
         ("M-s l" . consult-line)                  ;; needed by consult-line to detect isearch
         ("M-s L" . consult-line-multi)            ;; needed by consult-line to detect isearch
         ;; Minibuffer history
         :map minibuffer-local-map
         ("M-s" . consult-history)                 ;; orig. next-matching-history-element
         ("M-r" . consult-history))                ;; orig. previous-matching-history-element

  ;; Enable automatic preview at point in the *Completions* buffer. This is
  ;; relevant when you use the default completion UI.
  :hook (completion-list-mode . consult-preview-at-point-mode)

  ;; The :init configuration is always executed (Not lazy)
  :init
  (setq consult-locate-args "locate -i")

  ;; Optionally configure the register formatting. This improves the register
  ;; preview for `consult-register', `consult-register-load',
  ;; `consult-register-store' and the Emacs built-ins.
  (setq register-preview-delay 0.5
        register-preview-function #'consult-register-format)

  ;; Optionally tweak the register preview window.
  ;; This adds thin lines, sorting and hides the mode line of the window.
  (advice-add #'register-preview :override #'consult-register-window)

  ;; Configure other variables and modes in the :config section,
  ;; after lazily loading the package.
  :config

  ;; Optionally configure preview. The default value
  ;; is 'any, such that any key triggers the preview.
  ;; (setq consult-preview-key 'any)
  ;; (setq consult-preview-key "M-.")
  ;; (setq consult-preview-key '("S-<down>" "S-<up>"))
  ;; For some commands and buffer sources it is useful to configure the
  ;; :preview-key on a per-command basis using the `consult-customize' macro.

  (consult-customize
   consult-theme :preview-key '(:debounce 0.2 any)
   consult-ripgrep consult-git-grep consult-grep
   consult-bookmark consult-recent-file
   consult--source-bookmark consult--source-file-register
   consult--source-recent-file consult--source-project-recent-file
   ;; :preview-key "M-."
   :preview-key '(:debounce 0.4 any))

  ;; Optionally configure the narrowing key.
  ;; Both < and C-+ work reasonably well.
  (setq consult-narrow-key "<") ;; "C-+"
)
#+end_src

*** Corfu
Popup window for code completion
#+begin_src emacs-lisp
(use-package corfu
  :init
  (global-corfu-mode))
#+end_src

*** Dabbrev
Use dabbrev with Corfu
#+begin_src emacs-lisp
(use-package dabbrev
  ;; Swap M-/ and C-M-/
  :bind (("M-/" . dabbrev-completion)
	 ("C-M-/" . dabbrev-expand))
  :custom
  (dabbrev-ignored-buffer-regexps '("\\.\\(?:pdf\\|jpe?g\\|png\\)\\'")))
#+end_src

*** Isearch
Display counter showing the total number of matches
#+begin_src emacs-lisp
(setq isearch-lazy-count t)
(setq lazy-count-prefix-format "(%s/%s) ")
#+end_src

Make regular Isearch interpret space as a wildcard
#+begin_src emacs-lisp
(setq search-whitespace-regexp ".*?")
#+end_src

*** Marginalia
#+begin_src emacs-lisp
(use-package marginalia
  :ensure t
  :config
  (marginalia-mode))
#+end_src

*** Orderless
#+begin_src emacs-lisp
(use-package orderless
  :ensure t
  :init
  (setq completion-styles '(orderless basic)
        completion-category-defaults nil
        completion-category-overrides '((file (styles basic partial-completion)))))
#+end_src

*** Vertico
#+begin_src emacs-lisp
;; Enable vertico
(use-package vertico
  :bind (:map vertico-map
         ("?" . minibuffer-completion-help))
  :init
  (vertico-mode))

;; Persist history over Emacs restarts. Vertico sorts by history position.
(use-package savehist
  :init
  (savehist-mode))

;; A few more useful configurations...
(use-package emacs
  :init
  ;; Add prompt indicator to `completing-read-multiple'.
  ;; We display [CRM<separator>], e.g., [CRM,] if the separator is a comma.
  (defun crm-indicator (args)
    (cons (format "[CRM%s] %s"
		  (replace-regexp-in-string
		   "\\`\\[.*?]\\*\\|\\[.*?]\\*\\'" ""
		   crm-separator)
		  (car args))
	  (cdr args)))
  (advice-add #'completing-read-multiple :filter-args #'crm-indicator)

  ;; Do not allow the cursor in the minibuffer prompt
  (setq minibuffer-prompt-properties
	'(read-only t cursor-intangible t face minibuffer-prompt))
  (add-hook 'minibuffer-setup-hook #'cursor-intangible-mode)

  ;; Emacs 28: Hide commands in M-x which do not work in the current mode.
  ;; Vertico commands are hidden in normal buffers.
  ;; (setq read-extended-command-predicate
  ;;       #'command-completion-default-include-p)

  ;; Enable recursive minibuffers
  (setq enable-recursive-minibuffers t))
#+end_src

** Dired
Configure =dired= do use simplified view
#+begin_src emacs-lisp
(use-package dired
  :ensure nil  ; dired is built-in
  :bind (:map dired-mode-map
              ("C-c C-a" . org-attach-dired-to-subtree))
  :hook ((dired-mode . dired-hide-details-mode)
         (dired-mode . hl-line-mode))
  :custom
  (dired-dwim-target t))
#+end_src

Guess what shell command to apply to files
#+begin_src emacs-lisp :tangle no
(use-package dired-x
  :hook (dired-mode . (lambda() (dired-omit-mode 1)))
  :config
  (setq dired-guess-shell-alist-user
	'((".*" "open"))))
#+end_src

List directories first
#+begin_src emacs-lisp :tangle no
(use-package ls-lisp
  :custom
  (ls-lisp-dirs-first t)
  (ls-lisp-use-insert-directory-program nil))
#+end_src

** Embark
Provide a sort of "right-click contextual menu" for actions available in the
minibuffer, or for the symbol at point
#+begin_src emacs-lisp
(use-package embark
  :ensure t

  :bind
  (("C-." . embark-act)
   ("C-;" . embark-dwim)
   ("C-h B" . embark-bindings)) ;; alternative for `describe-bindings'

  :init
  ;; Optionally replace the key help with a completing-read interface
  ;; (setq prefix-help-command #'embark-prefix-help-command)

  :config
  ;; Hide the mode line of the Embark live/completions buffers
  (add-to-list 'display-buffer-alist
               '("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
                 nil
                 (window-parameters (mode-line-format . none)))))

(use-package embark-consult
  :ensure t
  :hook
  (embark-collect-mode . consult-preview-at-point-mode))
#+end_src

** Get INFOPATH from shell
#+begin_src emacs-lisp
(use-package exec-path-from-shell
  :config
  (exec-path-from-shell-initialize)
  (when (daemonp)
    (exec-path-from-shell-copy-env "INFOPATH"))

  ;; Now sync Info-directory-list from INFOPATH:
  (let ((infopath (getenv "INFOPATH")))
    (when (and infopath (not (string-empty-p infopath)))
      (dolist (dir (split-string infopath ":" t))
        (when (file-directory-p dir)
          (add-to-list 'Info-directory-list dir))))))
#+end_src
** GPTel

#+begin_src emacs-lisp
(use-package gptel
  :bind
  (("C-c RET" . gptel-send))
  :config
  (setq
   gptel-default-mode #'org-mode
   gptel-model 'gemini-3-pro-preview
   gptel-backend (gptel-make-openai "Portkey"
                   :protocol "https"
                   :host "api.portkey.ai"
                   :models '(gemini-3-pro-preview gpt-5 gpt-4o gpt-4o-mini gpt-4-turbo gpt-35-turbo-16k)
                   :endpoint "/v1/chat/completions"
                   :key #'gptel-api-key-from-auth-source))
  (gptel-make-openai "Lumiere"
    :protocol "http"
    :host "lumiere"
    :models '(llama3.2:latest)
    :endpoint ":3000/api/chat/completions"
    :key #'gptel-api-key-from-auth-source)
  (gptel-make-ollama "Ollama"
    :host "localhost:11434"
    :models '(gpt-oss:20b
              gemma3:4b)
    :stream t))
#+end_src

** Programming
*** C
#+begin_src emacs-lisp
(use-package cc-mode
  :defer t
  :bind (:map c-mode-map
              ("<f5>" . compile)
              ("C-c C-i" . insert-include-guard)))

(use-package google-c-style
  :hook ((c-mode-common . google-set-c-style)
	 (c-mode-common . google-make-newline-indent)))
#+end_src
*** Faust
#+begin_src emacs-lisp
(use-package faust-mode
  :mode ("\\.dsp\\'" . faust-mode))
#+end_src
*** Flymake
#+begin_src emacs-lisp
(use-package flymake
  :config
  :bind (:map flymake-mode-map
   ("C-x `"   . flymake-goto-next-error)
   ("M-g n"   . flymake-goto-next-error)
   ("M-g M-n" . flymake-goto-next-error)
   ("M-g p"   . flymake-goto-prev-error)
   ("M-g M-p" . flymake-goto-prev-error)
  )
)
#+end_src

*** Makefiles
#+begin_src emacs-lisp
(use-package make-mode
  :bind (:map makefile-mode-map
	      ("<f5>" . compile)))
#+end_src

*** Octave
#+begin_src emacs-lisp
(use-package octave
  :mode ("\\.m\\'" . octave-mode))
#+end_src

*** Python
#+begin_src emacs-lisp
(use-package python
  :bind (:map python-mode-map
	      ("<f11>" . numpydoc-generate)))

(use-package numpydoc
  :commands numpydoc-generate)

(use-package python-isort
    :hook ((python-mode . python-isort-on-save-mode)
           (python-ts-mode . python-isort-on-save-mode))
    :config
    (setq python-isort-arguments '("--line-length=88" "-m=3" "--tc" "--fgw=0"
                                   "--ca" "--stdout" "--atomic" "-")))
#+end_src

*** Conda configuration
#+begin_src emacs-lisp
(use-package conda
  :hook (eshell-mode . conda-env-initialize-eshell)
  ;; :init
  ;; (conda-env-initialize-interactive-shells)
  ;; (conda-env-autoactivate-mode t)
  )
#+end_src

*** Web pages
#+begin_src emacs-lisp
(use-package web-mode
  :mode ("\\.php\\'" "\\html?\\'"))
#+end_src

*** Treesitter parsers
In order to use the treesitter versions of these language modes, need to install
the corresponding grammars with =treesit-install-language-grammar=.
#+begin_src emacs-lisp
(add-to-list 'major-mode-remap-alist '(python-mode . python-ts-mode))
;; stay with non-treesitter modes for C/C++, for google-c-style to work
;; (add-to-list 'major-mode-remap-alist '(c-mode . c-ts-mode))
;; (add-to-list 'major-mode-remap-alist '(c++-mode . c++-ts-mode))
(add-to-list 'major-mode-remap-alist '(sh-mode . bash-ts-mode))
(add-to-list 'major-mode-remap-alist '(css-mode . css-ts-mode))
#+end_src

*** Eglot
Language server protocol (LSP) client
#+begin_src emacs-lisp
(use-package eglot
  :defer t)
#+end_src

*** Github copilot
#+begin_src emacs-lisp
(use-package editorconfig)
(use-package copilot
  :load-path "~/.emacs.d/packages/copilot"
  :commands copilot-mode
  :bind (:map prog-mode-map
         ("C-c p" . copilot-mode)
         :map copilot-completion-map
         ("<tab>" . copilot-accept-completion-by-word)
         ("M-<tab>" . copilot-accept-completion-by-line)
         ("C-M-<tab>" . copilot-accept-completion)))
#+end_src
** Org
#+begin_src emacs-lisp
(use-package org
  :defer t
  :bind (("C-c l" . org-store-link)
         ("C-c a" . org-agenda)
         ("C-c c" . org-capture)
         ("C-c d" . org-time-stamp-inactive))
  :config
  (setq org-agenda-files '("~/org/todo.org" "~/org/inbox.org" "~/gd/Reviews/reviews.org"))
  (setq org-default-notes-file "~/org/todo.org")
  (setq org-refile-targets '((nil . (:level . 1))
                             (org-agenda-files . (:level . 1))))
  ;; use symbolic links for attachments
  (setq org-attach-method 'lns)
  (setq org-startup-folded 'content)
  (require 'org-tempo)
  ;; use tempo for template expansion (e.g., <se [TAB])
  (add-to-list 'org-modules 'org-tempo t)
  (add-to-list 'org-structure-template-alist '("se" . "src emacs-lisp"))
  ;; (add-hook 'org-mode-hook 'variable-pitch-mode)
  (setq org-special-ctrl-a/e 'reversed)
  (setq org-src-preserve-indentation t)
  (setq org-highlight-latex-and-related '(latex script))
  (setq org-hide-leading-stars t)

  ;; follow links to email messages
  (org-add-link-type "message" 'cr-open-message-link)

  ;; Enable external applications to send stuff to org
  (require 'org-protocol)

  ;; Custom templates for org-capture
  (setq org-capture-templates
        '(
          ("e" "Email" entry (file+headline org-default-notes-file "Tasks")
           "* TODO %?  :email:\n  %a\n  %i")
          ("t" "Todo" entry (file+headline org-default-notes-file "Tasks")
           "* TODO %?")
          ("v" "Review" entry (file "~/gd/Reviews/reviews.org")
           "* TODO %?  :review:")
          )
        )

  ;; Custom views for org-agenda
  (setq org-agenda-custom-commands
        '(("A" "Agenda and upcoming deadlines"
           ((agenda ""
                    ((org-agenda-overriding-header "Today's agenda\n")
                     (org-agenda-span 1)
                     (org-deadline-warning-days 0)
                     (org-agenda-day-face-function (lambda (date) 'org-agenda-date))
                     (org-agenda-format-date "%A %-e %B %Y")))
            (agenda ""
                    ((org-agenda-overriding-header "\nNext three days\n")
                     (org-agenda-block-separator nil)
                     (org-agenda-start-on-weekday nil)
                     (org-agenda-start-day "+1d")
                     (org-agenda-span 3)
                     (org-deadline-warning-days 0)
                     (org-agenda-skip-function '(org-agenda-skip-entry-if 'todo 'done))))
            (agenda ""
                    ((org-agenda-overriding-header "\nUpcoming deadlines (+14d)\n")
                     (org-agenda-block-separator nil)
                     (org-agenda-time-grid nil)
                     (org-agenda-start-on-weekday nil)
                     (org-agenda-start-day "+3d")
                     (org-agenda-span 14)
                     (org-agenda-show-all-dates nil)
                     (org-deadline-warning-days 0)
                     (org-agenda-entry-types '(:deadline))
                     (org-agenda-skip-function '(org-agenda-skip-entry-if 'todo 'done))))))
          ("d" "Tasks without a date"
           ((alltodo ""
                       ((org-agenda-overriding-header "Tasks without a date\n")
                        (org-agenda-skip-function '(org-agenda-skip-entry-if 'scheduled 'deadline))))))
          ("e" "Emails"
           ((tags-todo "email")))
          ("h" "Tasks @home"
           ((tags-todo "@home")))
          ("r" "Tasks @rocky"
           ((tags-todo "@rocky")))
          ("q" "Tasks @equad"
           ((tags-todo "@equad")))
          ("v" "All reviews"
           ((tags-todo "review")))))

  ;; Set up TODO keywords
  (setq org-todo-keywords
        '((sequence "TODO(t)" "WAITING(w)" "|" "DONE(d)")
          (sequence "PROJECT(p)" "|" "FINISHED(f)")))

  (setq org-todo-keyword-faces
        '(("WAITING" . org-code)
          ("PROJECT" . org-macro))))

(use-package org-superstar
  :hook (org-mode . org-superstar-mode))
#+end_src

** Organ gigs
#+begin_src emacs-lisp
(use-package organ
  :ensure t
  :vc (:url "git@github.com:cwrowley/organ-emacs.git" :branch "main")
  :config
  (global-set-key (kbd "C-c o") 'organ-menu))
#+end_src
** RSS reader
*** Elfeed
#+begin_src emacs-lisp
  (use-package elfeed
    :bind ("C-x w" . elfeed)
    :config
    (setq elfeed-feeds
     '(("https://sachachua.com/blog/feed" emacs)
       ("https://www.howardism.org/index.xml" emacs)
       ;; ("http://arxiv.org/rss/math.DS" arxiv math)	    ; dynamical systems
       ;; ("http://arxiv.org/rss/math.NA" arxiv math)	    ; numerical analysis
       ;; ("http://arxiv.org/rss/math.OC" arxiv math)	    ; optimization and control
       ;; ("http://arxiv.org/rss/physics.flu-dyn" arxiv phys) ; fluid dynamics
       ;; ("http://arxiv.org/rss/physics.data-an" arxiv phys) ; data analysis
       ;; ("http://arxiv.org/rss/cs.CE" arxiv cs)	; computational engineering
       ;; ("http://arxiv.org/rss/cs.LG" arxiv cs)	; machine learning
       ;; ("http://arxiv.org/rss/eess.SP" arxiv ee)	; signal processing
       ;; ("http://arxiv.org/rss/eess.SY" arxiv ee)	; systems and control
      )))
#+end_src
** Swagger
#+begin_src emacs-lisp
(use-package swagg
  :config
  (setq swagg-definitions
        '((:name "Organ API"
                 :json "http://localhost:8000/openapi.json"
                 :base "http://localhost:8000"))))
#+end_src
** Terminals
*** Xterm-color
Use xterm-color for eshell
#+begin_src emacs-lisp
(use-package xterm-color
  :hook (eshell-mode . (lambda ()
			 (setenv "TERM" "xterm-256color"))))
#+end_src

*** Vterm
#+begin_src emacs-lisp
(use-package vterm
  :bind ("C-c t" . vterm))
#+end_src

** Text processing
*** Unfill
#+begin_src emacs-lisp
(use-package unfill
  :bind ([remap fill-paragraph] . unfill-toggle))
#+end_src

*** Flyspell
#+begin_src emacs-lisp
(use-package flyspell
  :hook ((text-mode . flyspell-mode)
	 (c-mode-common . flyspell-prog-mode)))
#+end_src

*** Ripgrep
Recursive grep in a directory
#+begin_src emacs-lisp
(use-package rg
  :defer t
  :after wgrep)
#+end_src

*** Snippets
#+begin_src emacs-lisp
(use-package yasnippet
  :delight yas-minor-mode
  :commands yas-minor-mode-on
  :bind (("C-c y d" . yas-load-directory)
         ("C-c y i" . yas-insert-snippet)
         ("C-c y f" . yas-visit-snippet-file)
         ("C-c y n" . yas-new-snippet)
         ("C-c y t" . yas-tryout-snippet)
         ("C-c y l" . yas-describe-tables)
         ("C-c y g" . yas-global-mode)
         ("C-c y m" . yas-minor-mode)
         ("C-c y r" . yas-reload-all)
         ("C-c y x" . yas-expand)
         :map yas-keymap
         ("C-i" . yas-next-field-or-maybe-expand))
  :mode ("/\\.emacs\\.d/snippets/" . snippet-mode)
  :hook (prog-mode . yas-minor-mode-on)
  :custom
  (yas-prompt-functions '(yas-completing-prompt yas-no-prompt))
  (yas-snippet-dirs (list (emacs-path "snippets")))
  (yas-triggers-in-field t)
  (yas-wrap-around-region t)
  :config
  (yas-load-directory (emacs-path "snippets")))
#+end_src

** TeX
*** AucTeX
#+begin_src emacs-lisp
(use-package tex
  :ensure auctex
  :defer t
  :defines font-latex-fontify-script
  :config
  (setq TeX-auto-save t)
  (setq TeX-parse-self t)
  (setq TeX-view-program-list '(("open" "open %o")
				("Skim" "/Applications/Skim.app/Contents/SharedSupport/displayline %n %o %b")))
  (setq TeX-view-program-selection '((output-dvi "open")
				     (output-pdf "Skim")
				     (output-html "open")))
  (add-hook 'LaTeX-mode-hook 'visual-line-mode)
  (add-hook 'LaTeX-mode-hook 'LaTeX-math-mode)
  (add-hook 'LaTeX-mode-hook 'TeX-source-correlate-mode)
  ;; do not fontify subscripts and superscripts
  (setq font-latex-fontify-script nil))

(use-package latex
  :ensure auctex
  ;; This local keymap binding must be done here, not in 'tex'
  :bind (:map LaTeX-mode-map
              ("<f5>" . compile)
              ("C-c x" . xenops-mode)))
#+end_src

*** RefTeX
#+begin_src emacs-lisp
(use-package reftex
  :hook (LaTeX-mode . turn-on-reftex)
  :config
  (setq reftex-plug-into-AUCTeX t)
  (setq reftex-use-external-file-finders t)
  (setq reftex-external-file-finders
	'(("tex" . "kpsewhich -format=.tex %f")
	  ("bib" . "kpsewhich -format=.bib %f")))
  (setq reftex-ref-macro-prompt nil)  ; do not prompt for ref/pageref
  ;; Define index macros
  (setq reftex-index-macros
	'(;("\\ii{*}" "idx" ?o "" nil t)
	  ("\\indexdefn{*}" "idx" ?d "" nil t)
	  ("\\defined{*}" "idx" ?D "" nil nil)
	  ("\\theoremname{*}" "idx" ?t "" nil nil)
	  index))
  (setq reftex-index-default-macro '(?i ""))
  (setq reftex-index-default-tag nil))
#+end_src

*** CDLaTeX
#+begin_src emacs-lisp
(use-package cdlatex
  :disabled
  :hook (LaTeX-mode . turn-on-cdlatex))
#+end_src

*** Xenops
Xenops provides inline previews of equations, tikz diagrams, and figures
#+begin_src emacs-lisp
(use-package xenops
  :defer t
  :config
  (setq xenops-math-image-scale-factor 1.6))
#+end_src

*** Ignore generated files
#+begin_src emacs-lisp
(setq completion-ignored-extensions
      (append completion-ignored-extensions
	     '(".fdb_latexmk" ".fls" ".log" ".out" ".pdf" ".synctex.gz")))
#+end_src

** Version control
*** Magit
#+begin_src emacs-lisp
(use-package magit
  :bind (("<f8>" . magit-status)
         ("C-x g" . magit-status)
	 ("C-c g" . magit-dispatch)
	 ("C-c f" . magit-file-dispatch)))
#+end_src

*** Highlight changed lines in gutter
#+begin_src emacs-lisp
(use-package diff-hl
  :hook ((vc-dir-mode . turn-on-diff-hl-mode)
	 (magit-pre-refresh . diff-hl-magit-pre-refresh)
	 (magit-post-refresh . diff-hl-magit-post-refresh))
  :init
  (global-diff-hl-mode))
#+end_src

*** Markdown
#+begin_src emacs-lisp
(use-package markdown-mode
  :mode (("\\`README\\.md\\'" . gfm-mode)
         ("\\.md\\'"          . markdown-mode)
         ("\\.markdown\\'"    . markdown-mode))
  :custom
  (markdown-command "pandoc -f gfm+smart")
  (markdown-command-needs-filename t)
  (markdown-enable-math t)
  (markdown-open-command "marked")
  :custom-face
  ;; (markdown-header-face-1 ((t (:inherit markdown-header-face-1 :height 2.0))))
  ;; (markdown-header-face-2 ((t (:inherit markdown-header-face-2 :height 1.6))))
  ;; (markdown-header-face-3 ((t (:inherit markdown-header-face-3 :height 1.4))))
  ;; (markdown-header-face-4 ((t (:inherit markdown-header-face-4 :height 1.2))))
)
#+end_src

** Other applications
*** Calc
#+begin_src emacs-lisp
(use-package calc
  :defer t
  :init
  (setq calc-gnuplot-default-device "qt"))
#+end_src

*** Ledger
#+begin_src emacs-lisp
(use-package ledger-mode
  :mode "\\.ledger\\'"
  :config
  (add-hook 'ledger-mode-hook
            (lambda ()
              (setq-local tab-always-indent 'complete)
              (setq-local completion-cycle-threshold t)
              (setq-local ledger-complete-in-steps t))))
#+end_src

* Fonts and themes
** Load various themes
#+begin_src emacs-lisp
(use-package ef-themes)

(use-package modus-themes
  :ensure t
  :config
  (setq modus-themes-italic-constructs t
        modus-themes-bold-constructs nil
        modus-themes-mixed-fonts t
        modus-themes-scale-headings t)

  (define-key global-map (kbd "<f5>") #'modus-themes-toggle))

(load-theme 'modus-vivendi-tinted :no-confirm)
#+end_src

** Fonts
#+begin_src emacs-lisp
(add-hook 'window-setup-hook
          (lambda ()
            (set-face-attribute 'default nil :family "Hack" :height 140)
            (set-face-attribute 'fixed-pitch nil :family "Hack" :height 140)
            (set-face-attribute 'variable-pitch nil :family "Fira Sans" :height 160)
            (add-to-list 'default-frame-alist '(alpha-background . 80))))
#+end_src

* Tidy up and start server
#+begin_src emacs-lisp
;; (server-start)
#+end_src
